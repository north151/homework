<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>可视化大作业</title>

    <!---------------------------------- JS -------------------------------------->
    <script type="text/javascript" src="./js/d3.v4.js"></script>

    <script type="text/javascript" src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://echarts.baidu.com/gallery/vendors/echarts/echarts.min.js"></script>
    <script type="text/javascript" src="https://echarts.baidu.com/gallery/vendors/echarts-gl/echarts-gl.min.js"></script>
    <script type="text/javascript" src="https://echarts.baidu.com/gallery/vendors/echarts-stat/ecStat.min.js"></script>
    <script type="text/javascript" src="https://echarts.baidu.com/gallery/vendors/echarts/extension/dataTool.min.js"></script>
    <script type="text/javascript" src="https://echarts.baidu.com/gallery/vendors/echarts/map/js/china.js"></script>
    <script type="text/javascript" src="https://echarts.baidu.com/gallery/vendors/echarts/map/js/world.js"></script>
    <script type="text/javascript" src="https://echarts.baidu.com/gallery/vendors/echarts/extension/bmap.min.js"></script>
    <script type="text/javascript" src="https://echarts.baidu.com/gallery/vendors/simplex.js"></script>

    <!-----------------------------------CSS -------------------------------------->
    <link rel="stylesheet" href="./css/style.css" />
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">

</head>






<body>

    <!---------------------------------------- 人物流动图 ------------------------------------------>

    <!-- 画布 -->
    <div id="svg1">
        <svg class="contain"></svg>
    </div>
    <!-- 某点位置的人数 -->
    <div id="tooltip" class="hidden">
        <p id="value"><strong>100</strong></p>
    </div>

    <!-- 时间文字 -->
    <div id="timeText">
        7:0:0
    </div>
    <!-- 时间拖动 -->
    <div id="container">
        <div id="control"></div>
    </div>



    <!----------------------------------- 时间点会场人数统计图 -------------------------->
    <!-- 人数统计 -->
    <div id="textContainer">
        <p><span>分会场A: </span><span id="confA"></span></p>
        <p><span>分会场B: </span><span id="confB"></span></p>
        <p><span>分会场C: </span><span id="confC"></span></p>
        <p><span>分会场D: </span><span id="confD"></span></p>
        <p><span style="margin-right: 10px;">主会场: </span><span id="conf"></span></p>
        <p><span>时间: </span><span id="time1"></span></p>
    </div>






    <!---------------------------------------- 人物流动图JS ------------------------------------------>
    <script type="text/javascript">
        var width = 800,
            height = 1000,
            padding = 50,
            svg,
            day, //数据集
            people = [], //对应时间点各人员位置
            index = [], //便于快速查找数据
            curr = 0,
            tmpData = d3.range(31),
            tmpData2 = d3.range(17),
            p = 40, //内边距
            xScale = d3.scaleLinear().domain([0, 30]).range([p, width - p]), //(2) 定义x和y比例尺
            gridSize = xScale(1) - xScale(0),
            peopleSize = 5,
            floor1 = [], //第一层的所有人
            floor2 = []; //第二层的所有人

        var grids1, grids2, bfb, time_min = 25200,
            time_max = 68400,
            now_time, old_time, rScale1, rScale2, area;

        var exits = [{
            x: 0,
            y: 19
        }, {
            x: 15,
            y: 5
        }, {
            x: 15,
            y: 15
        }, {
            x: 15,
            y: 17
        }];

        var son = $("#control");
        var parent = $("#container");
        //一层楼每个点人数的二维数组
        var grid_SumOfPeople_floor1 = new Array();
        var grid_SumOfPeople_floor2 = new Array();
        for (var i = 0; i < 16; i++) {
            //初始化数组
            grid_SumOfPeople_floor1[i] = new Array();
            grid_SumOfPeople_floor2[i] = new Array();
            for (var j = 0; j < 30; j++) {
                grid_SumOfPeople_floor1[i][j] = 0;
                grid_SumOfPeople_floor2[i][j] = 0;
            }
        }

        //position数据的转换函数
        var rowConventerDay = function(d) {
            return {
                id: parseInt(d.id),
                sid: parseInt(d.sid),
                time: parseInt(d.time),
                x: parseInt(d.x),
                y: parseInt(d.y),
                floor: parseInt(d.floor)
            };
        }


        svg = d3.select("#svg1 svg");
        d3.csv("./data/position.csv", rowConventerDay, function(dataday) {
            day = dataday;
            old_time = 25200;
            getTimeIn(day, old_time);

            for (var i = 0; i < people.length; i++) {
                var X = people[i].x;
                var Y = people[i].y;
                //到一楼
                if (people[i].floor == 1) {
                    floor1.push(people[i]);
                    grid_SumOfPeople_floor1[X][Y]++;
                }
                //到二楼 
                else {
                    floor2.push(people[i]);
                    grid_SumOfPeople_floor2[X][Y]++;
                }
            }

            //确定楼层绘图区域
            rScale1 = d3.scaleLinear()
                .domain([leastOfFour(grid_SumOfPeople_floor1), largestOfFour(grid_SumOfPeople_floor1)])
                .range([3, (gridSize - 3) / 2]);
            rScale2 = d3.scaleLinear()
                .domain([leastOfFour(grid_SumOfPeople_floor2), largestOfFour(grid_SumOfPeople_floor2)])
                .range([3, (gridSize - 3) / 2]);
            drawGrids();
            draws(floor1, 1);
            draws(floor2, 2);
            drag(son, parent);

            var svg = d3.select(".contain");

            //划分一楼房间并标注
            drawBorder1(1, 2, 5, 2);
            appendText(10.1, 2, "扶梯", 20);
            drawBorder1(1, 4, 5, 2);
            appendText(10.1, 15, "扶梯", 20);
            drawBorder1(1, 6, 5, 2);
            appendText(2, 3.5, "分会场A", 20);
            drawBorder1(1, 8, 5, 2);
            appendText(2, 5.5, "分会场B", 20);
            drawBorder1(7, 3, 2, 8);
            appendText(2, 7.5, "分会场C", 20);
            drawBorder1(10, 4, 2, 2);
            appendText(2, 9.5, "分会场D", 20);
            drawBorder1(10, 6, 2, 4);
            appendText(7.5, 5.5, "海", 20);
            appendText(7.5, 7.5, "报", 20);
            appendText(7.5, 9.5, "区", 20);
            drawBorder1(10, 10, 2, 2);
            appendText(2.7, 13.5, "签到处", 20);
            drawBorder1(2, 12, 4, 2);
            appendText(10, 5.5, "厕所1", 18);
            drawBorder1(15, 2, 4, 10);
            appendText(10, 8.4, "room1", 18);
            drawBorder1(19, 2, 10, 10);
            appendText(10, 11.4, "room2", 18);
            drawBorder1(19, 14, 2, 2);
            appendText(16, 7.4, "展 厅", 24);
            drawBorder1(21, 14, 4, 2);
            appendText(21.8, 7.4, "主 会 场", 24);
            drawBorder1(25, 14, 2, 2);
            appendText(19, 15.4, "服务台", 15);
            drawBorder1(27, 14, 2, 2);
            appendText(22.2, 15.4, "room3", 15);
            drawBorder1(10, 1, 2, 1);
            appendText(25.1, 15.4, "room4", 15);
            drawBorder1(10, 14, 2, 1);
            appendText(27.1, 15.4, "厕所2", 15);

            //划分二楼房间并标注
            drawBorder2(1, 2, 5, 8);
            appendText2(2.2, 6.6, "餐 厅", 24);
            drawBorder2(1, 10, 5, 2);
            appendText2(2.2, 11.4, "room5", 20);
            drawBorder2(0, 13, 6, 3);
            appendText2(1.7, 15, "休闲区", 20);
            drawBorder2(10, 4, 2, 2);
            appendText2(10.1, 2, "扶梯", 20);
            drawBorder2(10, 6, 2, 2);
            appendText2(10.1, 15, "扶梯", 20);
            drawBorder2(10, 1, 2, 1);
            appendText2(10, 5.5, "厕所3", 18);
            drawBorder2(10, 14, 2, 1);
            appendText2(10, 7.4, "room6", 18);


            //添加defs标签
            var defs = svg.append("defs");
            //添加marker标签及其属性
            var arrowMarker = defs.append("marker")
                .attr("id", "arrow")
                .attr("markerUnits", "strokeWidth")
                .attr("markerWidth", 12)
                .attr("markerHeight", 12)
                .attr("viewBox", "0 0 12 12")
                .attr("refX", 6)
                .attr("refY", 6)
                .attr("orient", "auto")

            var arrow_path = "M6,5 L8,6 L6,7 L6,6 L6,3";
            arrowMarker.append("path")
                .attr("d", arrow_path)
                .attr("fill", "rgb(255,181,62)")

            appendArrow(20, 0.8, 20, 0)
            appendArrow(-0.2, 13.6, 0.6, 13.6)
            appendArrow(3, 16.6, 3, 15.8)
            appendArrow(5, 16.6, 5, 15.8)
            appendArrow(8, 16.6, 8, 15.8)
            appendArrow(6, 15.2, 6, 16.0)
            appendArrow(16, 15.2, 16, 16.0)
            appendArrow(18, 15.2, 18, 16.0)

        });


        //一楼房间
        function drawBorder1(x, y, width, height) {
            svg.append('rect')
                .attr("x", padding + x * gridSize - gridSize / 2 + 2)
                .attr("y", padding + y * gridSize - gridSize / 2 + 2)
                .attr("width", gridSize * width)
                .attr("height", gridSize * height)
                .attr("fill", "none")
                .attr("stroke-width", 2)
                .attr("stroke", "black");
        }
        //一楼房间标注
        function appendText(x, y, str, fontSize) {
            svg.append('text')
                .attr('x', padding + x * gridSize - gridSize / 2 + 3)
                .attr('y', padding + y * gridSize - gridSize / 2 - 3)
                .text(str)
                .style('font-size', fontSize)
                .style('font-weight', 'bold')
                .style('font-family', 'cursive');
        }

        //二楼房间
        function drawBorder2(x, y, width, height) {
            svg.append('rect')
                .attr("x", padding + x * gridSize - gridSize / 2 + 2)
                .attr("y", padding + xScale(16) + y * gridSize - gridSize / 2 + 2)
                .attr("width", gridSize * width)
                .attr("height", gridSize * height)
                .attr("fill", "none")
                .attr("stroke-width", 2)
                .attr("stroke", "black");
        }
        //二楼房间标注
        function appendText2(x, y, str, fontSize) {
            svg.append('text')
                .attr('x', padding + x * gridSize - gridSize / 2 + 3)
                .attr('y', padding + xScale(16) + y * gridSize - gridSize / 2 - 3)
                .text(str)
                .style('font-size', fontSize)
                .style('font-weight', 'bold')
                .style('font-family', 'cursive');
        }





        // 人群数据
        function appendArrow(x1, y1, x2, y2) {
            svg.append('line')
                .attr("x1", padding + (x1 - 1) * gridSize + 2)
                .attr("y1", padding + y1 * gridSize - gridSize / 2)
                .attr("x2", padding + (x2 - 1) * gridSize + 2)
                .attr("y2", padding + y2 * gridSize - gridSize / 2)
                .attr('stroke', 'rgb(255,181,62)')
                .attr('stroke-width', 8)
                .attr("marker-end", "url(#arrow)");
        }

        // 人到达出口
        function GetIndex(m, d) {
            for (var i = 0; i < m.length; i++) {
                if (m[i].x == d.x && m[i].y == d.y)
                    return i;
            }
            return -1;
        }

        // 时间递增(右滑)
        function getTimeIn(day, time) {
            for (; curr < day.length; curr++) {
                if (day[curr].time < time) {
                    if (index.indexOf(day[curr].id) == -1) {
                        index.push(day[curr].id);
                        people.push(day[curr]);
                    } else {
                        var term = {
                            x: (day[curr].x),
                            y: (day[curr].y)
                        }; //判断是否到达出口位置
                        if (GetIndex(exits, term) == -1) {
                            people[index.indexOf(day[curr].id)] = day[curr];
                        } else //到达出口位置，需要删去该元素
                        {
                            people.splice(index.indexOf(day[curr].id), 1);
                            index.splice(index.indexOf(day[curr].id), 1);
                        }
                    }
                } else
                    break;
            }
        }

        //时间减少(左滑)
        function getTimeDe(day, time) {
            var result = [],
                indexs = [];
            for (var i = 0; i < day.length; i++) {
                if (day[i].time < time) {
                    if (indexs.indexOf(day[i].id) == -1) {
                        indexs.push(day[i].id);
                        result.push(day[i]);
                    } else {
                        var term = {
                            x: (day[i].x),
                            y: (day[i].y)
                        }; //判断是否到达出口位置
                        if (GetIndex(exits, term) == -1) {
                            result[indexs.indexOf(day[i].id)] = day[i];
                        } else {
                            result.splice(indexs.indexOf(day[i].id), 1);
                            indexs.splice(indexs.indexOf(day[i].id), 1);
                        }
                    }
                } else {
                    people = result;
                    index = indexs;
                    curr = i;
                    break;
                }
            }
        }


        //画人群
        function findX(x, floor) {
            return xScale(x) + gridSize / 2;
        }

        function findY(y, floor) {
            if (floor == 1) {
                return xScale(y) + gridSize / 2;
            } else {
                return xScale(16) + xScale(y) + gridSize / 2;
            }
        }

        function draws(floor, i) {
            if (floor.length > 0) {
                if (i == 1) {
                    var item = grids1.selectAll("circle")
                        .data(floor);
                    //update
                    item.attr("cx", function(d) {
                            return findX(d.y, 1);;
                        })
                        .attr("cy", function(d) {
                            return findY(d.x, 1);;
                        })
                        .attr("r", function(d) {
                            return rScale1(grid_SumOfPeople_floor1[d.x][d.y]);
                        })
                        .attr("class", "people");
                    //enter
                    item.enter()
                        .append("circle")
                        .attr("cx", function(d) {
                            return findX(d.y, 1);
                        })
                        .attr("cy", function(d) {
                            return findY(d.x, 1);
                        })
                        .attr("r", function(d) {
                            return rScale1(grid_SumOfPeople_floor1[d.x][d.y]);
                        })
                        .attr("class", "people");
                    //exit
                    item.exit()
                        .remove();
                } else {
                    var item = grids2.selectAll("circle")
                        .data(floor);
                    //update
                    item.attr("cx", function(d) {
                            return findX(d.y, 2);
                        })
                        .attr("cy", function(d) {
                            return findY(d.x, 2);
                        })
                        .attr("r", function(d) {
                            return rScale2(grid_SumOfPeople_floor2[d.x][d.y]);
                        })
                        .attr("class", "people");
                    //enter
                    item.enter()
                        .append("circle")
                        .attr("cx", function(d) {
                            return findX(d.y, 2);
                        })
                        .attr("cy", function(d) {
                            return findY(d.x, 2);
                        })
                        .attr("r", function(d) {
                            return rScale2(grid_SumOfPeople_floor2[d.x][d.y]);
                        })
                        .attr("class", "people");
                    //exit
                    item.exit()
                        .remove();
                }
            } else {
                if (i == 1) {
                    grids1.selectAll("circle")
                        .data(floor)
                        .exit()
                        .remove();
                } else {
                    grids2.selectAll("circle")
                        .data(floor)
                        .exit()
                        .remove();
                }
            }

        }

        //时间格式化
        function timeFormat(time) {
            var hour = parseInt(time / 3600);
            var minute = parseInt((time % 3600) / 60);
            var second = (time % 3600) % 60;
            return hour + ":" + minute + ":" + second;
        }


        // 拖动观察
        function drag(obj1, obj3) { // obj1:子元素的jQuery对象, obj3: 父元素的jQuery对象
            var x, y;
            var gapX, gapY;
            obj1.mousedown(start);
            // 启动动态图
            function start(event) {
                //是否点击鼠标左键
                if (event.button == 0) {
                    //减去鼠标相对于子元素的偏移量后，父元素相对于屏幕的横向距离
                    gapX = event.clientX - obj1.offset().left + obj3.offset().left;
                    //减去鼠标相对于子元素的偏移量后，父元素相对于屏幕的纵向距离
                    gapY = event.clientY - obj1.offset().top + obj3.offset().top;
                    $(document).mousemove(move);
                    $(document).mouseup(stop);
                }
            }

            //鼠标拖动
            function move(event) {
                bfb = parseFloat(((obj1.offset().left - obj3.offset().left) / (obj3[0].offsetWidth - obj1[0].offsetWidth)));
                //鼠标相对屏幕的横向距离 - 父元素相对于屏幕的横向距离
                x = event.clientX - gapX;
                //限制obj1移出obj3左端
                if (x < 0) {
                    x = 0;
                }
                //限制obj1移出obj3的右端
                else if (x > (obj3[0].offsetWidth - obj1[0].offsetWidth)) {
                    x = obj3[0].offsetWidth - obj1[0].offsetWidth;
                }
                obj1.css({
                    "left": x + "px"
                });
                now_time = parseInt(bfb * (time_max - time_min)) + time_min;
                d3.select("#timeText")
                    .text(function() {
                        return timeFormat(now_time);
                    });
            }

            //鼠标停下
            function stop() {
                $(document).unbind("mousemove", move);
                $(document).unbind("mouseup", stop);
                //往右滑动
                if (now_time > old_time) {
                    old_time = now_time;
                    getTimeIn(day, now_time);
                    floor1 = [];
                    floor2 = [];
                    for (var i = 0; i < 16; i++) {
                        for (var j = 0; j < 30; j++) {
                            grid_SumOfPeople_floor1[i][j] = 0;
                            grid_SumOfPeople_floor2[i][j] = 0;
                        }
                    }
                    for (var i = 0; i < people.length; i++) {
                        var X = people[i].x;
                        var Y = people[i].y;
                        if (people[i].floor == 1) {
                            floor1.push(people[i]);
                            grid_SumOfPeople_floor1[X][Y]++;
                        } else {
                            floor2.push(people[i]);
                            grid_SumOfPeople_floor2[X][Y]++;
                        }
                    }
                    rScale1.domain([leastOfFour(grid_SumOfPeople_floor1), largestOfFour(grid_SumOfPeople_floor1)]);
                    rScale2.domain([leastOfFour(grid_SumOfPeople_floor2), largestOfFour(grid_SumOfPeople_floor2)]);
                    draws(floor1, 1);
                    draws(floor2, 2);

                    grids1.selectAll(".ggrid")
                        .on("mousemove", function(d) {
                            console.log(event)
                            var xPosition = event.offsetX + 210;
                            var yPosition = event.offsetY + 70;
                            //更新tooltip
                            d3.select("#tooltip")
                                .style("left", xPosition + "px")
                                .style("top", yPosition + "px")
                                .select("#value")
                                .text(function() {
                                    return grid_SumOfPeople_floor1[d.x][d.y];
                                });
                            //展示tooltip
                            d3.select("#tooltip").classed("hidden", false);
                        })
                        .on("mouseout", function() {
                            //隐藏tooltip
                            d3.select("#tooltip").classed("hidden", true);

                        });

                    grids2.selectAll(".ggrid")
                        .on("mousemove", function(d) {
                            var xPosition = event.offsetX + 210;
                            var yPosition = event.offsetY + 70;
                            //更新tooltip
                            d3.select("#tooltip")
                                .style("left", xPosition + "px")
                                .style("top", yPosition + "px")
                                .select("#value")
                                .text(function() {
                                    return grid_SumOfPeople_floor2[d.x][d.y];
                                });
                            //展示tooltip
                            d3.select("#tooltip").classed("hidden", false);
                        })
                        .on("mouseout", function() {
                            //隐藏tooltip
                            d3.select("#tooltip").classed("hidden", true);

                        });
                }
                //往左滑动 
                else if (now_time < old_time) {
                    old_time = now_time;
                    getTimeDe(day, now_time);
                    floor1 = [];
                    floor2 = [];
                    for (var i = 0; i < 16; i++) {
                        for (var j = 0; j < 30; j++) {
                            grid_SumOfPeople_floor1[i][j] = 0;
                            grid_SumOfPeople_floor2[i][j] = 0;
                        }
                    }
                    for (var i = 0; i < people.length; i++) {
                        var X = people[i].x;
                        var Y = people[i].y;
                        if (people[i].floor == 1) {
                            floor1.push(people[i]);
                            grid_SumOfPeople_floor1[X][Y]++;
                        } else {
                            floor2.push(people[i]);
                            grid_SumOfPeople_floor2[X][Y]++;
                        }
                    }
                    rScale1.domain([leastOfFour(grid_SumOfPeople_floor1), largestOfFour(grid_SumOfPeople_floor1)]);
                    rScale2.domain([leastOfFour(grid_SumOfPeople_floor2), largestOfFour(grid_SumOfPeople_floor2)]);
                    draws(floor1, 1);
                    draws(floor2, 2);

                    grids1.selectAll(".ggrid")
                        .on("mousemove", function(d) {
                            var xPosition = event.offsetX + 210;
                            var yPosition = event.offsetY + 70;
                            //更新tooltip
                            d3.select("#tooltip")
                                .style("left", xPosition + "px")
                                .style("top", yPosition + "px")
                                .select("#value")
                                .text(function() {
                                    return grid_SumOfPeople_floor1[d.x][d.y];
                                });
                            //展示tooltip
                            d3.select("#tooltip").classed("hidden", false);
                        })
                        .on("mouseout", function() {
                            //隐藏tooltip
                            d3.select("#tooltip").classed("hidden", true);

                        });
                    grids2.selectAll(".ggrid")
                        .on("mousemove", function(d) {
                            var xPosition = event.offsetX + 210;
                            var yPosition = event.offsetY + 70;
                            //更新tooltip
                            d3.select("#tooltip")
                                .style("left", xPosition + "px")
                                .style("top", yPosition + "px")
                                .select("#value")
                                .text(function() {
                                    return grid_SumOfPeople_floor2[d.x][d.y];
                                });
                            //展示tooltip
                            d3.select("#tooltip").classed("hidden", false);
                        })
                        .on("mouseout", function() {
                            //隐藏tooltip
                            d3.select("#tooltip").classed("hidden", true);

                        });
                }
            }
        }
        //最大位置
        function largestOfFour(arr) {
            return d3.max(arr.map(Function.apply.bind(Math.max, null)), function(d) {
                return d;
            });
        }
        //最小位置
        function leastOfFour(arr) {
            return d3.min(arr.map(Function.apply.bind(Math.min, null)), function(d) {
                return d;
            });
        }



        //画布局图(网格)
        function drawGrids() {

            /////////////////一楼////////////////////////////////////
            /////////////////////////////////////////////////////////

            //一楼所有元素
            grids1 = svg.append("g").attr("class", "grids1");
            //一楼灰色区域
            var grayArea1 = grids1.append("g").attr("class", "grayArea1");
            //扶梯
            var futiArea1 = grids1.append("g").attr("class", "futiArea1");
            //各大分会场
            var confA = grids1.append("g").attr("class", "confA");
            var confB = grids1.append("g").attr("class", "confB");
            var confC = grids1.append("g").attr("class", "confC");
            var confD = grids1.append("g").attr("class", "confD");
            //签到处
            var signIn = grids1.append("g").attr("class", "signIn");
            //海报区
            var poster = grids1.append("g").attr("class", "poster");
            //一楼厕所
            var WC1 = grids1.append("g").attr("class", "WC1");
            //服务台
            var service = grids1.append("g").attr("class", "service");
            //一楼room
            var room1 = grids1.append("g").attr("class", "room1");
            var room2 = grids1.append("g").attr("class", "room2");
            var room3 = grids1.append("g").attr("class", "room3");
            var room4 = grids1.append("g").attr("class", "room4");
            //展厅
            var display = grids1.append("g").attr("class", "display");
            //主会场
            var conf = grids1.append("g").attr("class", "conf");
            //出入口
            var exArea = grids1.append("g").attr("class", "exArea");
            //白色区域
            var whiteArea1 = grids1.append("g").attr("class", "whiteArea1");


            //绘制一楼灰色区域
            var wcgqy = [
                0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29,
                0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 29,
                0, 12, 13, 14, 29,
                0, 12, 13, 14, 29,
                0, 12, 13, 14, 29,
                0, 12, 13, 14, 29,
                0, 12, 13, 14, 29,
                0, 12, 13, 14, 29,
                0, 12, 13, 14, 29,
                0, 12, 13, 14, 29,
                0, 1, 2, 3, 4, 5, 12, 13, 14, 29,
                0, 1, 2, 3, 4, 5, 12, 13, 14, 29,
                0, 29,
                29,
                0, 29,
                0, 1, 3, 6, 8, 9, 10, 11, 12, 13, 14, 16, 18, 29
            ];

            var wcgqx = [
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
                2, 2, 2, 2, 2,
                3, 3, 3, 3, 3,
                4, 4, 4, 4, 4,
                5, 5, 5, 5, 5,
                6, 6, 6, 6, 6,
                7, 7, 7, 7, 7,
                8, 8, 8, 8, 8,
                9, 9, 9, 9, 9,
                10, 10, 10, 10, 10, 10, 10, 10, 10, 10,
                11, 11, 11, 11, 11, 11, 11, 11, 11, 11,
                12, 12,
                13,
                14, 14,
                15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15
            ];
            var currArea = [];
            for (var i = 0; i < wcgqx.length; i++) {
                currArea.push({
                    x: (wcgqx[i]),
                    y: (wcgqy[i])
                });
            }
            drawItem1(grayArea1, currArea, "#D2D2D2");


            // 扶梯
            currArea = [];
            var futiy = [10, 11, 10, 11];
            var futix = [1, 1, 14, 14];
            for (var i = 0; i < futix.length; i++) {
                currArea.push({
                    x: (futix[i]),
                    y: (futiy[i])
                });
            }
            drawItem1(futiArea1, currArea, "yellow");


            //分会场A
            currArea = [];
            for (var i = 2; i < 4; i++) {
                for (var j = 1; j < 6; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            drawItem1(confA, currArea, "rgb(158,183,214)");
            //分会场B
            currArea = [];
            for (var i = 4; i < 6; i++) {
                for (var j = 1; j < 6; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            drawItem1(confB, currArea, "rgb(158,183,214)");
            //分会场C
            currArea = [];
            for (var i = 6; i < 8; i++) {
                for (var j = 1; j < 6; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            drawItem1(confC, currArea, "rgb(158,183,214)")
                //分会场D
            currArea = [];
            for (var i = 8; i < 10; i++) {
                for (var j = 1; j < 6; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            drawItem1(confD, currArea, "rgb(158,183,214)");


            //签到处
            currArea = [];
            for (var i = 12; i < 14; i++) {
                for (var j = 2; j < 6; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            drawItem1(signIn, currArea, "rgb(158,183,214)")


            //海报区
            currArea = [];
            for (var i = 3; i < 11; i++) {
                for (var j = 7; j < 9; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            drawItem1(poster, currArea, "rgb(158,183,214)");


            //展厅
            currArea = [];
            for (var i = 2; i < 12; i++) {
                for (var j = 15; j < 19; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            drawItem1(display, currArea, "rgb(158,183,214)");


            //主会场
            currArea = [];
            for (var i = 2; i < 12; i++) {
                for (var j = 19; j < 29; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            drawItem1(conf, currArea, "rgb(158,183,214)");


            //服务台
            currArea = [];
            for (var i = 14; i < 16; i++) {
                for (var j = 19; j < 21; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            drawItem1(service, currArea, "rgb(158,183,214)");

            //厕所
            currArea = [];
            for (var i = 4; i < 6; i++) {
                for (var j = 10; j < 12; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            for (var i = 14; i < 16; i++) {
                for (var j = 27; j < 29; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            drawItem1(WC1, currArea, "rgb(158,183,214)");


            // room1
            currArea = [];
            for (var i = 6; i < 10; i++) {
                for (var j = 10; j < 12; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            drawItem1(room1, currArea, "rgb(158,183,214)");
            // room2
            currArea = [];
            for (var i = 10; i < 12; i++) {
                for (var j = 10; j < 12; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            drawItem1(room2, currArea, "rgb(158,183,214)");
            // room3
            currArea = [];
            for (var i = 14; i < 16; i++) {
                for (var j = 21; j < 25; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            drawItem1(room3, currArea, "rgb(158,183,214)");
            // room4
            currArea = [];
            for (var i = 14; i < 16; i++) {
                for (var j = 25; j < 27; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            drawItem1(room4, currArea, "rgb(158,183,214)");

            // 出入口
            currArea = [];
            var cry = [0, 2, 4, 5, 7, 15, 17, 19];
            var crx = [13, 15, 15, 15, 15, 15, 15, 0];
            for (var i = 0; i < crx.length; i++) {
                currArea.push({
                    x: (crx[i]),
                    y: (cry[i])
                });
            }
            drawItem1(exArea, currArea, "rgb(235,238,236)");


            // 过道
            currArea = [];
            for (var i = 12; i < 29; i++) {
                currArea.push({
                    x: 1,
                    y: i
                });
            }
            for (var i = 2; i < 15; i++) {
                currArea.push({
                    x: i,
                    y: 6
                });
            }
            for (var i = 7; i < 9; i++) {
                currArea.push({
                    x: 2,
                    y: i
                });
            }
            for (var i = 2; i < 15; i++) {
                currArea.push({
                    x: i,
                    y: 9
                });
            }
            for (var i = 2; i < 4; i++) {
                for (var j = 10; j < 12; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            for (var i = 12; i < 15; i++) {
                currArea.push({
                    x: i,
                    y: 1
                });
            }
            for (var i = 2; i < 6; i++) {
                currArea.push({
                    x: 14,
                    y: i
                });
            }
            for (var i = 11; i < 15; i++) {
                for (var j = 7; j < 9; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            for (var i = 12; i < 14; i++) {
                for (var j = 10; j < 29; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            for (var i = 12; i < 19; i++) {
                currArea.push({
                    x: 14,
                    y: i
                });
            }
            drawItem1(whiteArea1, currArea, "rgb(235,238,236)")


            // 一楼绘制
            function drawItem1(item, data, color) {
                item.selectAll("rect")
                    .data(data)
                    .enter()
                    .append("rect")
                    .attr("x", function(d) {
                        return xScale(d.y);
                    })
                    .attr("y", function(d) {
                        return xScale(d.x);
                    })
                    .attr("width", gridSize)
                    .attr("height", gridSize)
                    .attr("fill", color)
                    .attr("class", "ggrid");
            }


            /////////////////二楼////////////////////////////////////
            /////////////////////////////////////////////////////////
            currArea = [];
            //画二楼
            //二楼所有元素
            grids2 = svg.append("g").attr("class", "grids2");
            //灰色区域
            var grayArea2 = grids2.append("g").attr("class", "grayArea2");
            //扶梯
            var futiArea2 = grids2.append("g").attr("class", "futiArea2");
            //room区域
            var room2 = grids2.append("g").attr("class", "room2");
            //食堂
            var canteen = grids2.append("g").attr("class", "canteen");
            //休闲区
            var relaxation = grids2.append("g").attr("class", "relaxation");
            //厕所
            var WC2 = grids2.append("g").attr("class", "WC2");
            //白色区域
            var whiteArea2 = grids2.append("g").attr("class", "whiteArea2");
            //二楼灰色区域绘制 ##D4D4D4
            var wcgqy2 = [
                0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11,
                0, 1, 2, 3, 4, 5, 6, 7, 8, 9,
                0,
                0,
                0,
                0,
                0,
                0,
                0, 10, 11,
                0, 10, 11,
                0, 10, 11,
                0, 10, 11,
                0, 1, 2, 3, 4, 5,
                6, 7, 8, 9, 10, 11
            ];
            var wcgqx2 = [
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
                2,
                3,
                4,
                5,
                6,
                7,
                8, 8, 8,
                9, 9, 9,
                10, 10, 10,
                11, 11, 11,
                12, 12, 12, 12, 12, 12,
                15, 15, 15, 15, 15, 15
            ];
            for (var i = 0; i < wcgqx2.length; i++) {
                currArea.push({
                    x: (wcgqx2[i]),
                    y: (wcgqy2[i])
                });
            }
            for (var i = 0; i < 16; i++) {
                for (var j = 12; j < 30; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            drawItem2(grayArea2, currArea, "#D2D2D2");

            //扶梯
            currArea = [];
            var futiy = [10, 11, 10, 11];
            var futix = [1, 1, 14, 14];
            for (var i = 0; i < futix.length; i++) {
                currArea.push({
                    x: (futix[i]),
                    y: (futiy[i])
                });
            }
            drawItem2(futiArea2, currArea, "yellow");

            //room2
            currArea = [];
            for (var i = 10; i < 12; i++) {
                for (var j = 1; j < 6; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            for (var i = 6; i < 8; i++) {
                for (var j = 10; j < 12; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            drawItem2(room2, currArea, "rgb(158,183,214)");

            //餐厅
            currArea = [];
            for (var i = 2; i < 10; i++) {
                for (var j = 1; j < 6; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            drawItem2(canteen, currArea, "rgb(158,183,214)");

            //休闲区
            currArea = [];
            for (var i = 13; i < 16; i++) {
                for (var j = 0; j < 6; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            drawItem2(relaxation, currArea, "rgb(158,183,214)");

            //厕所
            currArea = [];
            for (var i = 4; i < 6; i++) {
                for (var j = 10; j < 12; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            drawItem2(WC2, currArea, "rgb(158,183,214)");

            //过道
            currArea = [];
            for (var i = 2; i < 15; i++) {
                for (var j = 6; j < 10; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            for (var i = 2; i < 4; i++) {
                for (var j = 10; j < 12; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            for (var i = 12; i < 14; i++) {
                for (var j = 10; j < 12; j++) {
                    currArea.push({
                        x: i,
                        y: j
                    });
                }
            }
            drawItem2(whiteArea2, currArea, "rgb(235,238,236)");
            currArea = [];
        }

        //二楼绘制
        function drawItem2(item, data, color) {
            item.selectAll("rect")
                .data(data)
                .enter()
                .append("rect")
                .attr("x", function(d) {
                    return xScale(d.y);
                })
                .attr("y", function(d) {
                    return xScale(d.x) + xScale(16);
                })
                .attr("width", gridSize)
                .attr("height", gridSize)
                .attr("fill", color)
                .attr("class", "ggrid");
        }
    </script>












    <!----------------------------------- 时间点会场人数统计图JS -------------------------->

    <script type="text/javascript">
        var dataset;
        var result = [];
        var xScale1, yScale1;
        var svg2,
            width1 = 600,
            height1 = 400;
        svg2 = d3.select("body")
            .append("svg")
            .attr("width", width1)
            .attr("height", height1)
            .attr("class", "svg2");
        var color = d3.scaleOrdinal(d3.schemeCategory10);

        d3.csv("./data/conference.csv", function(data) {
            dataset = data;
            for (var i = 0; i < dataset.length; i++) {
                var pic = [];
                for (var key in dataset[i]) {
                    var temp = {
                        people: parseInt(dataset[i][key]),
                        time: parseInt(key)
                    };
                    pic.push(temp);
                }
                pic.shift();
                pic.pop();
                result.push({
                    place: i,
                    data: pic
                });
            }


            //坐标轴横轴
            xScale1 = d3.scaleLinear()
                .domain([
                    d3.min(result, function(d) {
                        return d3.min(d.data, function(dd) {
                            return dd.time;
                        })
                    }),
                    d3.max(result, function(d) {
                        return d3.max(d.data, function(dd) {
                            return dd.time;
                        })
                    })
                ])
                .range([padding, width1 - 2 * padding]);

            //坐标轴纵轴
            yScale1 = d3.scaleLinear()
                .domain([
                    d3.min(result, function(d) {
                        return d3.min(d.data, function(dd) {
                            return dd.people;
                        })
                    }),
                    d3.max(result, function(d) {
                        return d3.max(d.data, function(dd) {
                            return dd.people;
                        })
                    })
                ])
                .range([height1 - padding, padding])
                .nice();

            //坐标轴横坐标刻度
            var xAxis = d3.axisBottom().scale(xScale1)
                .tickFormat(function(d) {
                    return timeFormat(d); //格式化时间坐标
                });
            svg2.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(" + 0 + ", " + (height1 - padding) + ")")
                .attr("id", "xAxisG")
                .call(xAxis);

            // 坐标轴纵坐标刻度
            var yAxis = d3.axisLeft().scale(yScale1);
            svg2.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(" + (padding) + ", 0)")
                .attr("id", "yAxisG")
                .call(yAxis);

            //图例布局
            var legend = svg2.append("g")
                .attr("class", "legend")
                .attr("x", width1 - padding)
                .attr("y", padding)
                .attr("height", 100)
                .attr("width", 100);
            //图例绘制
            legend.selectAll("g")
                .data(result)
                .enter()
                .append("g")
                .each(function(d, i) {
                    var g = d3.select(this);
                    g.append("rect")
                        .attr("x", width1 - 2 * padding)
                        .attr("y", function() {
                            return padding + i * 25;
                        })
                        .attr("width", 14)
                        .attr("height", 14)
                        .style("fill", color(i));
                    g.append("text")
                        .attr("x", width1 - 2 * padding + 25)
                        .attr("y", function() {
                            return padding + i * 25 + 12;
                        })
                        .text(function() {
                            return i == 0 ? "分会场A" : i == 1 ? "分会场B" : i == 2 ? "分会场C" : i == 3 ? "分会场D" : "主会场";
                        })
                        .attr("font-family", "sans-serif")
                        .attr("font-size", "14px");
                });


            //突出显示指定图例的折线图
            legend.selectAll("g")
                .on("mouseover", function(d) {
                    legend.selectAll("g").style("opacity", 0.1);
                    d3.select(this).style("opacity", 1);
                    d3.selectAll(".pp")
                        .each(function(dd) {
                            var g = d3.select(this);
                            g.style("opacity", function() {
                                return d.place == dd.place ? 1 : 0.1;
                            });
                        })
                })
                .on("mouseout", function(d) {
                    legend.selectAll("g").style("opacity", 1);
                    d3.selectAll(".pp").style("opacity", 1);
                });



            //折线
            var line = d3.line()
                .x(function(d) {
                    return xScale1(d.time);
                })
                .y(function(d) {
                    return yScale1(d.people);
                });
            //折线绘制
            svg2.selectAll(".pp")
                .data(result)
                .enter()
                .append("g")
                .attr("class", "pp")
                .append("path")
                .datum(function(d) {
                    return d.data;
                })
                .attr("class", "line")
                .attr("stroke", function(d, i) {
                    return color(i);
                })
                .attr("fill", "none")
                .attr("stroke-width", 3)
                .attr("opacity", 1)
                .attr("d", line);

            //鼠标移动竖线
            svg2.append("line")
                .attr("id", "YY")
                .attr("stroke-dasharray", '5,5');


            // 统计当下时间 各会议室人数
            svg2.on("mousemove", function(d) {
                var x = event.offsetX;
                var y = event.offsetY;
                if (x >= padding && x <= width1 - 2 * padding) {
                    var time = parseInt(xScale1.invert(x));
                    svg2.select("#YY")
                        .attr("x1", x)
                        .attr("y1", height1 - padding)
                        .attr("x2", x)
                        .attr("y2", padding)
                        .attr("stroke", "gray")
                        .attr("opacity", 1);

                    d3.select("#confA").text(getPeople(time, result[0]));
                    d3.select("#confB").text(getPeople(time, result[1]));
                    d3.select("#confC").text(getPeople(time, result[2]));
                    d3.select("#confD").text(getPeople(time, result[3]));
                    d3.select("#conf").text(getPeople(time, result[4]));
                    d3.select("#time1").text(timeFormat(time)); //当前时间
                }

            });
        });


        //时间格式
        function timeFormat(time) {
            var hour = parseInt(time / 3600);
            var minute = parseInt((time % 3600) / 60);
            var second = (time % 3600) % 60;
            return hour + ":" + minute + ":" + second;
        }

        //人数统计
        function getPeople(time, place) {
            var index = time - 25240;
            return place.data[index].people;
        }
    </script>

</body>


</html>